<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Agenda</title>
    <!-- iOS Add to Home Screen hints -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Agenda" />

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 (UMD) + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (para usar JSX en este archivo) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      html, body, #root { height: 100%; }
      body { -webkit-tap-highlight-color: transparent; }
    </style>
  </head>
  <body class="bg-white">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useRef, useEffect } = React;

      // === Agenda iPad ‚Äî Calendario con vistas Mes | Semana | D√≠a ===
      // - Navegaci√≥n (anterior/siguiente) por vista
      // - Bot√≥n "Hoy"
      // - Tap en Mes/Semana ‚Üí ir a D√≠a
      // - Deslizar en D√≠a para ‚Üê/‚Üí
      // - Notas por d√≠a (sin horas)
      // - Selector de clientes: lista cerrada (desde localStorage) + "Fuera de ruta"
      // - Importar clientes/plan pegando JSON (sobrescribe localStorage)

      function App() {
        const WEEK_STARTS_ON = 1; // Lunes
        const locale = "es-ES";

        const today = useMemo(() => stripTime(new Date()), []);
        const [currentView, setCurrentView] = useState("month");
        const [viewDate, setViewDate] = useState(() => stripTime(new Date()));
        const [selectedDate, setSelectedDate] = useState(null);

        // Notas (RAM)
        const [itemsByDate, setItemsByDate] = useState({});
        const [showEditor, setShowEditor] = useState(false);
        const [draft, setDraft] = useState({ mode: "lista", cliente: "", texto: "" });
        const [editingId, setEditingId] = useState(null);
        const [editDraft, setEditDraft] = useState({ mode: "lista", cliente: "", texto: "" });
        const canSaveNew = useMemo(() => (draft.mode === "lista" ? !!draft.cliente : (draft.cliente||"").trim().length>0), [draft]);
        const canSaveEdit = useMemo(() => (editDraft.mode === "lista" ? !!editDraft.cliente : (editDraft.cliente||"").trim().length>0), [editDraft]);
        const idSeq = useRef(1);

        // Import (pegar JSON)
        const [showImport, setShowImport] = useState(false);
        const [clientsJsonText, setClientsJsonText] = useState("");
        const [planJsonText, setPlanJsonText] = useState("");
        const [importError, setImportError] = useState("");
        const [dataVersion, setDataVersion] = useState(0); // para refrescar lecturas de localStorage

        // Datos de clientes/plan desde localStorage
        const { clientNames, clientsById } = useMemo(() => readClientsFromLocalStorage(), [dataVersion]);
        const planByDate = useMemo(() => readPlanByDateFromLocalStorage(), [dataVersion]);
        const clients = useMemo(() => (clientNames.length ? clientNames : defaultClients()), [clientNames]);

        // Gestos (d√≠a)
        const tX = useRef(0), tY = useRef(0);
        const onTouchStart = (e)=>{ if(!e.touches?.length) return; tX.current=e.touches[0].clientX; tY.current=e.touches[0].clientY; };
        const onTouchEnd = (e)=>{
          if(!e.changedTouches?.length) return;
          const dx = e.changedTouches[0].clientX - tX.current;
          const dy = e.changedTouches[0].clientY - tY.current;
          const ax = Math.abs(dx), ay = Math.abs(dy);
          if (ax>40 && ax>ay*1.3){
            const nd = addDays(viewDate, dx<0?1:-1); setViewDate(nd); setSelectedDate(nd);
          }
        };

        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();

        // Labels
        const headerLabel = useMemo(()=>{
          if (currentView==="month") return formatMonthYear(viewDate, locale);
          if (currentView==="week"){ const s=startOfWeek(viewDate,1), e=endOfWeek(viewDate,1); return formatWeekRange(s,e,locale); }
          return formatDay(viewDate, locale);
        }, [currentView, viewDate]);

        // Datos por vista
        const monthMatrix = useMemo(()=>buildMonthMatrix(year, month, WEEK_STARTS_ON),[year,month]);
        const weekRow = useMemo(()=>buildWeekRow(viewDate, WEEK_STARTS_ON), [viewDate]);
        const currentKey = useMemo(()=>ymd(viewDate), [viewDate]);
        const items = itemsByDate[currentKey] || [];
        const plannedIdsForDay = planByDate[currentKey] || [];

        const notesOfWeek = useMemo(()=>{
          const all=[]; const ref=viewDate;
          for (const d of weekRow){ const k=ymd(d); const arr=itemsByDate[k]||[]; for (const it of arr) all.push({...it, date:d}); }
          all.sort((a,b)=>{ const da=(stripTime(a.date)-ref)/86400000, db=(stripTime(b.date)-ref)/86400000; const ad=Math.abs(da), bd=Math.abs(db); if(ad!==bd) return ad-bd; if(da!==db) return da-db; return 0;});
          return all;
        }, [itemsByDate, weekRow, viewDate]);

        // Nav
        const goPrev = ()=>{ if(currentView==="month") setViewDate(addMonths(viewDate,-1)); else if(currentView==="week") setViewDate(addDays(viewDate,-7)); else { const nd=addDays(viewDate,-1); setViewDate(nd); setSelectedDate(nd);} };
        const goNext = ()=>{ if(currentView==="month") setViewDate(addMonths(viewDate,1)); else if(currentView==="week") setViewDate(addDays(viewDate,7)); else { const nd=addDays(viewDate,1); setViewDate(nd); setSelectedDate(nd);} };
        const goToday = ()=>{ setViewDate(today); setSelectedDate(today); };
        const onPick = (day)=>{ setSelectedDate(day); setViewDate(day); if(currentView!=="day") setCurrentView("day"); };

        // CRUD notas
        const addItemFor = (key, item)=> setItemsByDate(prev=>({ ...prev, [key]: [ ...(prev[key]||[]), item ] }));
        const replaceItemsFor = (key, mapper)=> setItemsByDate(prev=>({ ...prev, [key]: (prev[key]||[]).map(mapper) }));
        const removeItemFor = (key, id)=> setItemsByDate(prev=>({ ...prev, [key]: (prev[key]||[]).filter(x=>x.id!==id) }));

        const openNew = ()=>{ setDraft({ mode:"lista", cliente:"", texto:"" }); setShowEditor(true); };
        const cancelNew = ()=> setShowEditor(false);
        const saveNew = ()=>{
          const valid = draft.mode==="lista" ? !!draft.cliente : (draft.cliente||"").trim().length>0; if(!valid) return;
          const key = ymd(viewDate); const id = String(idSeq.current++);
          addItemFor(key, { id, cliente: draft.cliente, texto: draft.texto, fueraRuta: draft.mode==="custom" });
          setShowEditor(false);
        };

        const startEdit = (it)=>{ setEditingId(it.id); setEditDraft({ mode: it.fueraRuta?"custom":"lista", cliente: it.cliente||"", texto: it.texto||"" }); };
        const cancelEdit = ()=> setEditingId(null);
        const saveEdit = ()=>{
          const valid = editDraft.mode==="lista" ? !!editDraft.cliente : (editDraft.cliente||"").trim().length>0; if(!valid) return;
          const key = ymd(viewDate);
          replaceItemsFor(key, (x)=> x.id!==editingId ? x : { ...x, cliente: editDraft.cliente, texto: editDraft.texto, fueraRuta: editDraft.mode==="custom" });
          setEditingId(null);
        };
        const deleteItem = (id)=> removeItemFor(ymd(viewDate), id);

        const isSameDay = (a,b)=> !!a && !!b && ymd(a)===ymd(b);

        return (
          <div className="min-h-screen bg-white text-gray-900 flex flex-col">
            {/* Header */}
            <header className="sticky top-0 z-10 border-b bg-white/80 backdrop-blur">
              <div className="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between gap-2">
                <div className="flex items-center gap-2">
                  <button onClick={goPrev} aria-label="Anterior" className="h-10 w-10 rounded-2xl border text-xl leading-none hover:bg-gray-50 active:scale-[0.98]">‚Äπ</button>
                  <button onClick={goNext} aria-label="Siguiente" className="h-10 w-10 rounded-2xl border text-xl leading-none hover:bg-gray-50 active:scale-[0.98]">‚Ä∫</button>
                </div>
                <h1 className="text-base sm:text-lg md:text-xl font-semibold capitalize select-none">{headerLabel}</h1>
                <div className="flex items-center gap-2">
                  <div className="hidden sm:grid grid-cols-3 rounded-2xl border overflow-hidden text-sm">
                    {[{key:"month",label:"Mes"},{key:"week",label:"Semana"},{key:"day",label:"D√≠a"}].map(v=>
                      <button key={v.key} onClick={()=>setCurrentView(v.key)} className={["px-3 py-1.5 font-medium", currentView===v.key?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"].join(" ")} aria-pressed={currentView===v.key}>{v.label}</button>
                    )}
                  </div>
                  <button onClick={goToday} className="h-10 px-3 rounded-2xl border font-medium hover:bg-gray-50 active:scale-[0.98]">Hoy</button>
                  <button onClick={()=>{ setShowImport(true); setImportError(""); }} className="h-10 px-3 rounded-2xl border font-medium hover:bg-gray-50 active:scale-[0.98]" title="Pegar clientes.json y plan.json">Importar</button>
                </div>
              </div>
              {/* Selector vista m√≥vil */}
              <div className="sm:hidden max-w-3xl mx-auto px-4 pb-3">
                <div className="grid grid-cols-3 rounded-2xl border overflow-hidden text-sm">
                  {[{key:"month",label:"Mes"},{key:"week",label:"Semana"},{key:"day",label:"D√≠a"}].map(v=>
                    <button key={v.key} onClick={()=>setCurrentView(v.key)} className={["px-3 py-2 font-medium", currentView===v.key?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"].join(" ")} aria-pressed={currentView===v.key}>{v.label}</button>
                  )}
                </div>
              </div>
            </header>

            {/* MAIN */}
            <main className="max-w-3xl mx-auto w-full px-2 sm:px-4 py-4 grow">
              {/* Encabezado de d√≠as (mes/semana) */}
              {(currentView==="month" || currentView==="week") && (
                <div className="grid grid-cols-7 text-center text-xs sm:text-sm font-medium text-gray-500 select-none">
                  {weekdayLabels(locale, WEEK_STARTS_ON).map(d=> <div key={d} className="py-2">{d}</div>)}
                </div>
              )}

              {/* MES */}
              {currentView==="month" && (
                <div className="grid grid-cols-7 gap-1 sm:gap-2">
                  {buildMonthMatrix(year, month, WEEK_STARTS_ON).map((week, wi)=>
                    <React.Fragment key={wi}>
                      {week.map(day=>{
                        const inCurrent = day.getMonth()===month;
                        const isToday = isSameDay(day, today);
                        const isSelected = isSameDay(day, selectedDate);
                        return (
                          <button key={ymd(day)} onClick={()=>onPick(day)}
                            className={["aspect-square w-full rounded-2xl border text-sm sm:text-base flex items-center justify-center select-none","transition-transform active:scale-[0.98]", inCurrent?"bg-white":"bg-gray-50 text-gray-300", isSelected?"bg-blue-600 text-white border-blue-600":"", (!isSelected&&isToday)?"ring-2 ring-blue-500":"", "hover:bg-gray-50"].join(" ")}
                            aria-pressed={isSelected} aria-current={isToday?"date":undefined}
                            title={new Intl.DateTimeFormat(locale,{weekday:"long",day:"numeric",month:"long",year:"numeric"}).format(day)}>
                            <span className="tabular-nums font-medium">{day.getDate()}</span>
                          </button>
                        );
                      })}
                    </React.Fragment>
                  )}
                </div>
              )}

              {/* SEMANA */}
              {currentView==="week" && (
                <>
                  <div className="grid grid-cols-7 gap-1 sm:gap-2">
                    {buildWeekRow(viewDate, WEEK_STARTS_ON).map(day=>{
                      const isToday = isSameDay(day, today);
                      const isSelected = isSameDay(day, selectedDate);
                      return (
                        <button key={ymd(day)} onClick={()=>onPick(day)}
                          className={["aspect-square w-full rounded-2xl border text-base flex items-center justify-center select-none","transition-transform active:scale-[0.98]","bg-white", isSelected?"bg-blue-600 text-white border-blue-600":"", (!isSelected&&isToday)?"ring-2 ring-blue-500":"", "hover:bg-gray-50"].join(" ")}
                          aria-pressed={isSelected} aria-current={isToday?"date":undefined}>
                          <div className="flex flex-col items-center leading-tight">
                            <span className="text-xs text-gray-500 font-medium">{new Intl.DateTimeFormat(locale,{weekday:"short"}).format(day)}</span>
                            <span className="tabular-nums font-semibold text-lg">{day.getDate()}</span>
                          </div>
                        </button>
                      );
                    })}
                  </div>
                  {/* Lista de notas de la semana */}
                  <div className="mt-4 rounded-2xl border overflow-hidden">
                    <div className="px-4 py-3 flex items-center justify-between">
                      <h2 className="text-sm font-semibold">Notas de la semana</h2>
                      <span className="text-xs text-gray-500">{notesOfWeek.length}</span>
                    </div>
                    <ul className="border-t divide-y">
                      {notesOfWeek.length ? (
                        notesOfWeek.map((it,i)=>
                          <li key={it.id+"-"+ymd(it.date)+"-"+i} className="px-4 py-2 text-sm flex items-start gap-2">
                            <span className="shrink-0 w-16 text-xs text-gray-500">{formatShortDate(it.date)}</span>
                            <div className="flex-1">
                              <div className="font-medium">
                                {it.cliente||"(Sin cliente)"}
                                {it.fueraRuta && <span className="text-[10px] px-1.5 py-0.5 rounded-full border ml-1">Fuera de ruta</span>}
                              </div>
                              <div className="text-gray-600">{it.texto||"(Sin descripci√≥n)"}</div>
                            </div>
                          </li>
                        )
                      ) : (
                        <li className="px-4 py-3 text-sm text-gray-400">Sin notas esta semana.</li>
                      )}
                    </ul>
                  </div>
                </>
              )}

              {/* D√çA */}
              {currentView==="day" && (
                <div className="space-y-3" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
                  <div className="px-4 py-4 rounded-2xl border flex items-center gap-3">
                    <div className="h-10 w-10 rounded-2xl bg-blue-600 text-white grid place-items-center text-lg font-bold">{viewDate.getDate()}</div>
                    <div className="flex flex-col">
                      <span className="text-sm text-gray-500 font-medium">{new Intl.DateTimeFormat(locale,{weekday:"long"}).format(viewDate)}</span>
                      <span className="text-base font-semibold">{formatDayNoWeekday(viewDate, locale)}</span>
                    </div>
                  </div>

                  {/* Plan del d√≠a */}
                  <div className="rounded-2xl border overflow-hidden">
                    <div className="px-4 py-3 flex items-center justify-between">
                      <h2 className="text-sm font-semibold">Plan del d√≠a</h2>
                      <span className="text-xs text-gray-500">{plannedIdsForDay.length} clientes</span>
                    </div>
                    <ul className="border-t divide-y">
                      {plannedIdsForDay.length ? (
                        plannedIdsForDay.map(id=> <li key={id} className="px-4 py-2 text-sm">{(clientsById[id]||{}).nombre || `ID ${id}`}</li>)
                      ) : (
                        <li className="px-4 py-3 text-sm text-gray-400">Sin plan para este d√≠a.</li>
                      )}
                    </ul>
                  </div>

                  {/* Notas */}
                  <div className="rounded-2xl border overflow-hidden flex flex-col">
                    <div className="px-4 py-3 flex items-center justify-between">
                      <h2 className="text-sm font-semibold">Notas</h2>
                      <button onClick={()=>setShowEditor(true)} className="h-9 px-3 rounded-2xl border font-medium hover:bg-gray-50">+ Nueva nota</button>
                    </div>

                    {showEditor && (
                      <div className="px-4 pb-4 space-y-2 border-t">
                        <div className="flex gap-2">
                          {draft.mode === "lista" ? (
                            <select value={draft.cliente} onChange={(e)=>setDraft(d=>({...d, cliente:e.target.value}))} className="h-9 rounded-2xl border px-3 flex-1">
                              <option value="" disabled>Selecciona cliente</option>
                              {clients.map(c=> <option key={c} value={c}>{c}</option>)}
                            </select>
                          ) : (
                            <input value={draft.cliente} onChange={(e)=>setDraft(d=>({...d, cliente:e.target.value}))} placeholder="Cliente (fuera de ruta)" className="h-9 rounded-2xl border px-3 flex-1" />
                          )}
                          <button onClick={()=>setDraft(d=>({...d, mode: d.mode==="lista"?"custom":"lista"}))} className="h-9 px-3 rounded-2xl border" title={draft.mode==="lista"?"Crear fuera de ruta":"Volver a lista"}>{draft.mode==="lista"?"Fuera de ruta":"Lista clientes"}</button>
                        </div>
                        <textarea value={draft.texto} onChange={(e)=>setDraft(d=>({...d, texto:e.target.value}))} placeholder="Descripci√≥n" className="w-full min-h[80px] rounded-2xl border p-3" />
                        <div className="flex justify-end gap-2">
                          <button onClick={()=>setShowEditor(false)} className="h-9 px-3 rounded-2xl border">Cancelar</button>
                          <button onClick={saveNew} disabled={!canSaveNew} className="h-9 px-3 rounded-2xl border bg-blue-600 text-white border-blue-600 disabled:opacity-60 disabled:cursor-not-allowed">Guardar</button>
                        </div>
                      </div>
                    )}

                    <div className="border-t min-h-[120px] max-h-[50vh] overflow-y-auto overscroll-contain">
                      <ul className="divide-y">
                        {(itemsByDate[currentKey]||[]).length ? (
                          (itemsByDate[currentKey]||[]).map(it=>
                            <li key={it.id} className="px-4 py-3 space-y-2">
                              {editingId===it.id ? (
                                <div className="space-y-2">
                                  <div className="flex gap-2">
                                    {editDraft.mode === "lista" ? (
                                      <select value={editDraft.cliente} onChange={(e)=>setEditDraft(d=>({...d, cliente:e.target.value}))} className="h-9 rounded-2xl border px-3 flex-1">
                                        <option value="" disabled>Selecciona cliente</option>
                                        {clients.map(c=> <option key={c} value={c}>{c}</option>)}
                                      </select>
                                    ) : (
                                      <input value={editDraft.cliente} onChange={(e)=>setEditDraft(d=>({...d, cliente:e.target.value}))} placeholder="Cliente (fuera de ruta)" className="h-9 rounded-2xl border px-3 flex-1" />
                                    )}
                                    <button onClick={()=>setEditDraft(d=>({...d, mode: d.mode==="lista"?"custom":"lista"}))} className="h-9 px-3 rounded-2xl border" title={editDraft.mode==="lista"?"Crear fuera de ruta":"Volver a lista"}>{editDraft.mode==="lista"?"Fuera de ruta":"Lista clientes"}</button>
                                  </div>
                                  <textarea value={editDraft.texto} onChange={(e)=>setEditDraft(d=>({...d, texto:e.target.value}))} placeholder="Descripci√≥n" className="w-full min-h-[80px] rounded-2xl border p-3" />
                                  <div className="flex justify-end gap-2">
                                    <button onClick={cancelEdit} className="h-9 px-3 rounded-2xl border">Cancelar</button>
                                    <button onClick={saveEdit} disabled={!canSaveEdit} className="h-9 px-3 rounded-2xl border bg-blue-600 text-white border-blue-600 disabled:opacity-60 disabled:cursor-not-allowed">Guardar</button>
                                  </div>
                                </div>
                              ) : (
                                <div className="flex items-start gap-3">
                                  <div className="shrink-0 h-2.5 w-2.5 rounded-full bg-blue-600 mt-2" />
                                  <div className="flex-1">
                                    <div className="text-sm font-medium flex items-center gap-2">
                                      <span>{it.cliente||"(Sin cliente)"}</span>
                                      {it.fueraRuta && <span className="text-[10px] px-2 py-0.5 rounded-full border uppercase tracking-wide">Fuera de ruta</span>}
                                    </div>
                                    <div className="text-sm text-gray-600 whitespace-pre-wrap">{it.texto||"(Sin descripci√≥n)"}</div>
                                  </div>
                                  <div className="flex gap-2">
                                    <button onClick={()=>startEdit(it)} className="h-8 px-2 rounded-2xl border text-xs">‚úèÔ∏è</button>
                                    <button onClick={()=>deleteItem(it.id)} className="h-8 px-2 rounded-2xl border text-xs">üóëÔ∏è</button>
                                  </div>
                                </div>
                              )}
                            </li>
                          )
                        ) : (
                          <li className="px-4 py-6 text-sm text-gray-400">Sin notas. Pulsa ‚Äú+ Nueva nota‚Äù.</li>
                        )}
                      </ul>
                    </div>
                  </div>
                </div>
              )}
            </main>

            <footer className="h-6" />

            {/* Modal Importar JSON */}
            {showImport && (
              <div className="fixed inset-0 z-50 bg-black/40 grid place-items-center px-3">
                <div className="max-w-3xl w-full bg-white rounded-2xl shadow-xl overflow-hidden">
                  <div className="px-4 py-3 border-b flex items-center justify-between">
                    <h3 className="font-semibold">Importar datos (pegar JSON)</h3>
                    <button onClick={()=>setShowImport(false)} className="h-9 px-3 rounded-2xl border">Cerrar</button>
                  </div>
                  <div className="grid md:grid-cols-2 gap-4 p-4">
                    <div className="flex flex-col gap-2">
                      <label className="text-sm font-medium">clientes.json</label>
                      <textarea value={clientsJsonText} onChange={(e)=>setClientsJsonText(e.target.value)} placeholder='[
  {"id":"1030755","nombre":"BAR A MOTORA"}
]' className="min-h-[180px] rounded-2xl border p-3 font-mono text-xs"></textarea>
                    </div>
                    <div className="flex flex-col gap-2">
                      <label className="text-sm font-medium">plan.json</label>
                      <textarea value={planJsonText} onChange={(e)=>setPlanJsonText(e.target.value)} placeholder='[
  {"fecha":"2025-09-29","clienteIds":["1030755","459565"]}
]' className="min-h-[180px] rounded-2xl border p-3 font-mono text-xs"></textarea>
                    </div>
                  </div>
                  {importError && <div className="px-4 pb-2 text-sm text-red-600">{importError}</div>}
                  <div className="px-4 pb-4 flex justify-end gap-2">
                    <button onClick={()=>setShowImport(false)} className="h-9 px-3 rounded-2xl border">Cancelar</button>
                    <button onClick={()=>{
                      try{
                        const rawClients = parseJsonSafe(clientsJsonText);
                        const rawPlan = parseJsonSafe(planJsonText);
                        if (!rawClients || !Array.isArray(rawClients)) throw new Error("clientes.json inv√°lido");
                        if (!rawPlan || !Array.isArray(rawPlan)) throw new Error("plan.json inv√°lido");
                        const normClients = normalizeClients(rawClients);
                        const normPlan = normalizePlan(rawPlan);
                        localStorage.setItem("agenda.version","1");
                        localStorage.setItem("agenda.clientes", JSON.stringify(normClients));
                        localStorage.setItem("agenda.plan", JSON.stringify(normPlan));
                        setDataVersion(v=>v+1);
                        setShowImport(false); setClientsJsonText(""); setPlanJsonText(""); setImportError("");
                      } catch(err){ setImportError(err?.message || String(err)); }
                    }} className="h-9 px-3 rounded-2xl border bg-blue-600 text-white border-blue-600">Validar y guardar</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // === Helpers & datos ===
      function weekdayLabels(locale="es-ES", weekStartsOn=1){ const base=["L","M","X","J","V","S","D"]; if(weekStartsOn===1) return base; const i=weekStartsOn%7; return base.slice(i).concat(base.slice(0,i)); }
      function buildMonthMatrix(year, month, weekStartsOn=1){ const first=new Date(year,month,1); const off=mod(first.getDay()-weekStartsOn,7); const start=stripTime(new Date(year,month,1-off)); const weeks=[]; let cur=new Date(start); for(let w=0;w<6;w++){ const row=[]; for(let d=0;d<7;d++){ row.push(new Date(cur)); cur.setDate(cur.getDate()+1);} weeks.push(row);} return weeks; }
      function buildWeekRow(anchor, weekStartsOn=1){ const s=startOfWeek(anchor,weekStartsOn); const arr=[]; for(let i=0;i<7;i++){ const d=new Date(s); d.setDate(s.getDate()+i); arr.push(d);} return arr; }
      function startOfWeek(date, weekStartsOn=1){ const d=stripTime(date); const diff=mod(d.getDay()-weekStartsOn,7); d.setDate(d.getDate()-diff); return d; }
      function endOfWeek(date, weekStartsOn=1){ const s=startOfWeek(date,weekStartsOn); const e=new Date(s); e.setDate(s.getDate()+6); return e; }
      function stripTime(d){ const nd=new Date(d); nd.setHours(0,0,0,0); return nd; }
      function addDays(d,n){ const nd=new Date(d); nd.setDate(nd.getDate()+n); return stripTime(nd); }
      function addMonths(d,n){ const nd=new Date(d); nd.setMonth(nd.getMonth()+n,1); return stripTime(nd); }
      function mod(n,m){ return ((n%m)+m)%m; }
      function ymd(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,"0"); const day=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${day}`; }
      function monthName(date, locale="es-ES", variant="long"){ return new Intl.DateTimeFormat(locale,{month:variant}).format(date); }
      function formatMonthYear(date, locale="es-ES"){ return `${capitalize(monthName(date,locale,"long"))} ${date.getFullYear()}`; }
      function formatWeekRange(s,e,locale="es-ES"){ const sameM=s.getMonth()===e.getMonth(); const sameY=s.getFullYear()===e.getFullYear(); const sd=s.getDate(), ed=e.getDate(); const sm=monthName(s,locale,"short"), em=monthName(e,locale,"short"); if(sameM) return `${sd}‚Äì${ed} ${sm} ${s.getFullYear()}`; if(sameY) return `${sd} ${sm} ‚Äì ${ed} ${em} ${s.getFullYear()}`; return `${sd} ${sm} ${s.getFullYear()} ‚Äì ${ed} ${em} ${e.getFullYear()}`; }
      function formatDay(date, locale="es-ES"){ const wd=new Intl.DateTimeFormat(locale,{weekday:"short"}).format(date); const m=monthName(date,locale,"long"); return `${wd} ${String(date.getDate()).padStart(2,"0")} ${m} ${date.getFullYear()}`; }
      function formatDayNoWeekday(date, locale="es-ES"){ const m=monthName(date,locale,"long"); return `${String(date.getDate()).padStart(2,"0")} ${m} ${date.getFullYear()}`; }
      function formatShortDate(date){ return new Intl.DateTimeFormat('es-ES',{weekday:'short',day:'2-digit',month:'short'}).format(date); }
      function capitalize(s){ return s? s.charAt(0).toUpperCase()+s.slice(1):s; }

      function defaultClients(){ return ["Bar Cafeter√≠a Sol","Restaurante Mar","Pub Atl√°ntico","La Terraza","Hotel R√≠a"]; }
      function readClientsFromLocalStorage(){ try{ if(typeof window==="undefined") return {clientNames:[],clientsById:{}}; const s=localStorage.getItem("agenda.clientes"); if(!s) return {clientNames:[],clientsById:{}}; const arr=JSON.parse(s); if(!Array.isArray(arr)) return {clientNames:[],clientsById:{}}; const names=[]; const byId={}; const seen=new Set(); for(const it of arr){ if(!it||typeof it.id!=="string"||typeof it.nombre!=="string") continue; byId[it.id]={id:it.id,nombre:it.nombre}; if(!seen.has(it.nombre)){ names.push(it.nombre); seen.add(it.nombre);} } return {clientNames:names, clientsById:byId}; } catch(_){ return {clientNames:[],clientsById:{}}; } }
      function readPlanByDateFromLocalStorage(){ const out={}; try{ if(typeof window==="undefined") return out; const s=localStorage.getItem("agenda.plan"); if(!s) return out; const arr=JSON.parse(s); if(!Array.isArray(arr)) return out; for(const it of arr){ if(!it||typeof it.fecha!=="string"||!Array.isArray(it.clienteIds)) continue; const uniq=[]; const seen=new Set(); for(const c of it.clienteIds){ const id=String(c); if(!id||seen.has(id)) continue; seen.add(id); uniq.push(id);} out[it.fecha]=uniq; } } catch(_){ } return out; }

      function parseJsonSafe(txt){ try{return JSON.parse(txt);}catch{ return null; } }
      function isIsoDate(s){ return typeof s==="string" && /^\d{4}-\d{2}-\d{2}$/.test(s); }
      function normalizeClients(arr){ if(!Array.isArray(arr)) throw new Error("clientes.json debe ser un array"); const out=[]; const seen=new Set(); for(const it of arr){ if(!it||typeof it.id!=="string"||typeof it.nombre!=="string") throw new Error("clientes.json: cada elemento necesita id y nombre (strings)"); const id=it.id.trim(), nombre=it.nombre.trim(); if(!id||!nombre) throw new Error("clientes.json: id/nombre vac√≠o"); if(seen.has(id)) continue; seen.add(id); out.push({id,nombre}); } return out; }
      function normalizePlan(arr){ if(!Array.isArray(arr)) throw new Error("plan.json debe ser un array"); const out=[]; for(const it of arr){ if(!it||!isIsoDate(it.fecha)||!Array.isArray(it.clienteIds)) throw new Error("plan.json: requiere fecha YYYY-MM-DD y clienteIds (array)"); const fecha=it.fecha; const clienteIds=it.clienteIds.map(c=>String(c)).filter(Boolean); out.push({fecha, clienteIds}); } return out; }

      // Tests simples (no bloquear)
      if (!window.__agendaTestsRan){
        try{
          const mm=buildMonthMatrix(2025,8,1); console.assert(mm.length===6 && mm.every(r=>r.length===7), 'Mes 6x7');
          const s=startOfWeek(new Date(2025,8,26),1), e=endOfWeek(new Date(2025,8,26),1); console.assert(s.getDay()===1 && (e-s)/86400000===6,'Semana lun-dom');
          console.assert(formatShortDate(new Date(2025,8,26)).length>0,'formatShortDate');
          console.assert(Array.isArray(defaultClients())&&defaultClients().length>=5,'defaultClients');
          console.assert(parseJsonSafe('x')===null,'parseJsonSafe inv√°lido');
          window.__agendaTestsRan=true;
        }catch(err){ console.warn('Tests fallaron', err); }
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App/>);
    </script>
  </body>
</html>
